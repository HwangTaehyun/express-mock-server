{"version":3,"file":"request-handler.js","names":["APPLICATION_JSON","sendResponse","response","res","next","file","type","path","status","StatusCodes","INTERNAL_SERVER_ERROR","send","end","statusCode","sendFile","dotfiles","headers","Date","now","err","console","log","body","requestHandler","sourcesParser","req","method","route","definitions","getMap","matchedRecord","length","methods","POST","matchRecordPost","GET","PUT","DELETE","PATCH","matchRecordGet","bgRed","white","bgBlue","yellow","query","NOT_FOUND","isFunction","params","forEach","headerItem","setHeader","contentType","delay","setTimeout"],"sources":["../../lib/core/request-handler.js"],"sourcesContent":["import { StatusCodes } from 'http-status-codes';\nimport { methods } from '../constants';\nimport { isFunction } from './utils';\nimport { matchRecordPost } from './matchers/http-post-matcher';\nimport { matchRecordGet } from './matchers/http-get-matcher';\n\nconst APPLICATION_JSON = 'application/json';\n\nconst sendResponse = (response, res, next) => {\n  if (response.file) {\n    const { type, path } = response.file;\n\n    if (!type) {\n      res\n        .status(StatusCodes.INTERNAL_SERVER_ERROR)\n        .send('File type has to be specified!')\n        .end();\n      return;\n    }\n\n    if (!path) {\n      res\n        .status(StatusCodes.INTERNAL_SERVER_ERROR)\n        .send('File path has to be specified!')\n        .end();\n      return;\n    }\n\n    res.status(response.statusCode).type(type);\n    res.sendFile(\n      path,\n      {\n        dotfiles: 'deny',\n        headers: {\n          'x-timestamp': Date.now(),\n          'x-sent': true,\n        },\n      },\n      function (err) {\n        if (err) {\n          next(err);\n        } else {\n          console.log('Sent:', path);\n        }\n      }\n    );\n  } else {\n    res.send(response.body);\n  }\n};\n\nexport const requestHandler = (sourcesParser, req, res, next) => {\n  let method = req.method;\n  let path = req.route.path;\n  let definitions = sourcesParser.getMap()[path][method];\n\n  // console.log(method);\n  // console.log(req.body);\n\n  let response = null;\n  let matchedRecord = null;\n\n  if (definitions.length === 1) {\n    matchedRecord = definitions[0];\n    response = matchedRecord.response;\n  } else {\n    switch (method) {\n      case methods.POST: {\n        matchedRecord = matchRecordPost(req, definitions);\n        break;\n      }\n\n      case methods.GET:\n      case methods.PUT:\n      case methods.DELETE:\n      case methods.PATCH:\n      default: {\n        matchedRecord = matchRecordGet(req, definitions);\n      }\n    }\n\n    if (matchedRecord !== null) {\n      response = matchedRecord.response;\n    }\n\n    if (response === null) {\n      console.log('ERR no reaponse but why?'.bgRed.white);\n      console.log('I know this URL but no match for parameters.'.bgBlue.white);\n      console.log(`method ${method}    path ${path}`);\n      console.log('QUERY'.yellow);\n      console.log(req.query);\n      console.log('BODY'.yellow);\n      console.log(req.body);\n      console.log('bundle'.yellow);\n      // myLog(bundle);\n      res\n        .status(StatusCodes.NOT_FOUND)\n        .send('NOT FOUND - no reaponse but why? Look to console.')\n        .end();\n      return;\n    }\n  }\n\n  if (isFunction(response)) {\n    response = response(req.params, req.query, req.body);\n  }\n\n  if (!!response.headers) {\n    response.headers.forEach((headerItem) => {\n      res.setHeader(headerItem['name'], headerItem['values'][0]);\n    });\n  }\n\n  res.status(response.statusCode).type(response.contentType || APPLICATION_JSON);\n\n  if (response.delay) {\n    setTimeout(() => {\n      sendResponse(response, res, next);\n    }, response.delay);\n  } else {\n    sendResponse(response, res, next);\n  }\n};\n"],"mappings":"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"}